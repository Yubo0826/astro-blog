---
heroImage: /src/assets/images/bg.jpg
category: Security
description: 常見網路攻擊CSRF的介紹與防禦
pubDate: 2025-02-04T16:00:00.000Z
tags:
  - CSRF
  - Security
title: CSRF（Cross-Site Request Forgery）介紹與防禦措施
---

## CSRF 簡介

### 攻擊機制

受害者進入第三方網站，在第三方網站中，向被攻擊網站發送跨站請求，執行未經授權的操作，如轉帳、修改密碼等。

### 攻擊流程

- 受害者登入 **a.com**，並保留了登入記錄（Cookie）
- 攻擊者引誘受害者造訪了 **b.com**
- **b.com** 在受害者不知情的情況下，向 **a.com** 發送了一個請求
- **a.com** 接收到請求後，對請求進行驗證，並確認是受害者的請求，誤認為是受害者發送自己的請求
- 攻擊完成，攻擊者在受害者不知情的情況下，冒充受害者，讓 a.com 執行自己定義的操作

CSRF 可以透過get請求，即透過造訪img的頁面後，瀏覽器自動存取目標位址，發送請求。例如：

```html
<img src="https://bank.com/transfer?amount=1000&to=attacker" />
```

同樣，也可以設定一個自動提交的表單發送post請求：

```html
<form action="http://bank.example/withdraw" method="POST">
	<input type="hidden" name="account" value="xiaoming" />
	<input type="hidden" name="amount" value="10000" />
	<input type="hidden" name="for" value="hacker" />
</form>
<script>
	document.forms[0].submit()
</script>
```

還有一種使用a標籤的，需要使用者點擊連結才會觸發。

```html
< a href="http://test.com/csrf/withdraw.php?amount=1000&for=hacker" taget="_blank">
抽獎請點擊這！！<a />
```

### CSRF的特點

- 攻擊一般在第三方網站發起，而不是被攻擊的網站。
- 攻擊利用受害者在被攻擊網站的登入資源，冒充受害者的操作方式；而不是直接竊取數據
- 整個過程攻擊者並不能取得受害者的登入資料，相反地“**冒用**”
- 跨站請求可以採用多種方式：圖片URL、超連結、CORS、表單提交等。

## CSRF 防禦方法

### 1. CSRF Token

每次發送請求時，伺服器都要求帶上一個隨機生成的 CSRF Token，攻擊者無法輕易獲取這個 Token，因此無法偽造請求。

實作方式：

- 伺服器端在表單內嵌入 Token：

```html
<input type="hidden" name="csrf_token" value="random_token_here" />
```

- 伺服器驗證 csrf_token 是否正確

### 2. SameSite Cookie

設定 Cookie 的 SameSite 屬性，限制它只能在相同 origin 的請求中發送。

SameSite 屬性有三個值：

**Strict**：完全禁止跨站請求攜帶 Cookie（安全性最高）

**Lax**：允許部分安全的跨站請求（如 GET 請求）。

**None**：允許所有跨站請求，但必須搭配 Secure（只允許 https）。

### 3. CORS（跨來源資源共享）

CORS 預設禁止跨站請求訪問受保護的資源，可透過適當的設定，限制哪些來源能夠存取 API：

```
Access - Control - Allow - Origin: https://trusted-site.com
```

### 4. 認證機制由 Session-based 改用 Token-based

當使用 Session 機制（基於 Cookie）時：

- Session ID 存在 Cookie 中，每次請求都會自動攜帶。
- 容易被 XSS（跨站腳本攻擊）盜取。
- 容易遭受 CSRF（跨站請求偽造）攻擊，因為瀏覽器會自動發送 Cookie。

而改用 JWT + Authorization 標頭（如 Bearer Token）：

- 避免 CSRF：Token 不會被瀏覽器自動發送，攻擊者無法偽造請求。
- 更安全：Token 存在 HTTP 標頭中，不會受到 Cookie 攻擊影響。
- 可無狀態：Token 驗證是獨立的，不依賴伺服器存儲狀態，適合分散式架構。
